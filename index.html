<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Printing System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --scale: 1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .input-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .input-section h2 {
      margin-bottom: 10px;
      color: #555;
    }

    .input-options {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-options button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .input-options button:hover {
      background-color: #45a049;
    }

    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }

    .file-input {
      margin-top: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .controls button {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    #addBtn { background-color: #2196F3; color: white; }
    #addBtn:hover { background-color: #0b7dda; }

    #mergeBtn { background-color: #FF9800; color: white; }
    #mergeBtn:hover { background-color: #e68a00; }

    #downloadBtn { background-color: #4CAF50; color: white; }
    #downloadBtn:hover { background-color: #45a049; }

    #printBtn { background-color: #9C27B0; color: white; }
    #printBtn:hover { background-color: #7b1fa2; }

    .layout-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .preview-section {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .flexy {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      width: 70%;
    }

    .page {
      width: 210mm;
      height: 297mm;
      margin: 0 auto 20px;
      padding: 5mm;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      page-break-after: always;
      position: relative;
      overflow: hidden;
    }

    .card-grid {
      display: grid;
      width: 100%;
      height: 100%;
      gap: 2mm;
    }

    .card {
      border: 1px solid #ddd;
      padding: calc(2mm * var(--scale));
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
      height: 100%;
      font-size: calc(9px * var(--scale));
      background: white;
      overflow: hidden;
    }

    .card-logo { width: calc(25px * var(--scale)); height: calc(25px * var(--scale)); }
    .card-amount { font-weight: bold; font-size: calc(12px * var(--scale)); margin-bottom: calc(0.5mm * var(--scale)); }
    .card-ref { font-size: calc(10px * var(--scale)); margin-bottom: calc(0.5mm * var(--scale)); }
    .jbonly { font-weight: bold; }
    .card-serial { font-family: 'Times New Roman'; font-size: calc(11px * var(--scale)); margin: 0;}
    .card-pin { font-family: 'Times New Roman'; font-size: calc(14px * var(--scale)); margin: 0;}
    .pinonly { font-weight: bold; }
    .card-date { font-size: calc(9px * var(--scale)); color: #666; margin: 0;}

    .topit {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: nowrap;
    }

    .no-preview {
      text-align: center;
      padding: 20px;
      color: #888;
      font-style: italic;
    }

    .page-count { color: #555; font-size: 14px; }

    @media print {
      @page { size: A4; margin: 0; }
      body { background-color: white; padding: 0; margin: 0; }
      .container { box-shadow: none; padding: 0; margin: 0; width: 210mm; height: 297mm; }
      .container h1, .input-section, .controls, .layout-selector, .preview-section .flexy, .page-count { display: none; }
      .page { box-shadow: none; margin: 0; padding: 5mm; width: 210mm; height: 297mm; page-break-after: always; }
      .preview-section { margin: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Card Printing System</h1>
    <div class="input-section">
      <h2>Input Card Data</h2>
      <div class="input-options">
        <button id="pasteBtn">Paste Text</button>
        <input type="file" id="fileInput" class="file-input" accept=".txt">
      </div>
      <textarea id="textInput" placeholder="Paste your card data here or upload a .txt file"></textarea>
    </div>

    <div class="controls">
      <button id="addBtn">Add Cards</button>
      <button id="mergeBtn">Merge Cards</button>
      <button id="downloadBtn">Download PDF</button>
      <button id="printBtn">Print</button>
    </div>

    <div class="layout-selector">
      <label for="layoutSelect">Layout:</label>
      <select id="layoutSelect">
        <option value="10x4">10x4 (40 cards per page)</option>
        <option value="15x4">15x4 (60 cards per page)</option>
        <option value="12x4">12x4 (48 cards per page)</option>
        <option value="15x3">15x3 (45 cards per page)</option>
        <option value="12x3">12x3 (36 cards per page)</option>
        <option value="10x3">10x3 (30 cards per page)</option>
      </select>
    </div>

    <div class="preview-section">
      <div class="flexy">
        <h2>Preview</h2>
        <span class="page-count" id="pageCount"></span>
      </div>
      <div id="previewContainer">
        <div class="no-preview">No cards added yet. Add cards to see preview.</div>
      </div>
    </div>
  </div>

  <script>
    let allCards = [];
    const networkLogos = {
      'MTN': 'mtn.png','AIRTEL': 'airtel.png','GLO': 'glo.png','9MOBILE': '9mobile.png',
      'Mtn': 'mtn.png','Airtel': 'airtel.png','Glo': 'glo.png','9mobile': '9mobile.png'
    };

    const textInput = document.getElementById('textInput');
    const fileInput = document.getElementById('fileInput');
    const pasteBtn = document.getElementById('pasteBtn');
    const addBtn = document.getElementById('addBtn');
    const mergeBtn = document.getElementById('mergeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const layoutSelect = document.getElementById('layoutSelect');
    const previewContainer = document.getElementById('previewContainer');
    const pageCountElement = document.getElementById('pageCount');

    pasteBtn.addEventListener('click', () => {
      navigator.clipboard.readText().then(text => textInput.value = text);
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => textInput.value = e.target.result;
      reader.readAsText(file);
    });

    function parseCardData(text) {
      const lines = text.split('\n'), cards = [];
      for (const line of lines) {
        if (!line.trim() || line.includes('Serial') || line.includes('Pin')) continue;
        const parts = line.trim().split(/\s+/);
        if (parts.length >= 5 && /^\d{14,}/.test(parts[0]) && /^\d{5,}/.test(parts[1])) {
          cards.push({
            serial: parts[0],
            pin: parts[1],
            network: parts[2],
            amount: parts[3],
            date: parts.slice(4).join(' ')
          });
        } else if (parts.length >= 6 && /^\d+$/.test(parts[0]) && parts[2].startsWith('@')) {
          cards.push({
            index: parts[0],
            date: parts[1] + " " + parts[2],
            network: parts[3],
            amount: parts[4],
            serial: parts[5],
            pin: parts[6]
          });
        }
      }
      return cards;
    }

    addBtn.addEventListener('click', () => {
      const newCards = parseCardData(textInput.value.trim());
      allCards = newCards;
      textInput.value = ''; fileInput.value = '';
      renderPreview();
    });

    mergeBtn.addEventListener('click', () => {
      const newCards = parseCardData(textInput.value.trim());
      allCards = [...allCards, ...newCards];
      textInput.value = ''; fileInput.value = '';
      renderPreview();
    });

    layoutSelect.addEventListener('change', renderPreview);

    function renderPreview() {
      if (allCards.length === 0) {
        previewContainer.innerHTML = '<div class="no-preview">No cards added yet.</div>';
        pageCountElement.textContent = ''; return;
      }
      const [rows, cols] = layoutSelect.value.split('x').map(Number);
      const cardsPerPage = rows * cols;
      const pageCount = Math.ceil(allCards.length / cardsPerPage);
      pageCountElement.textContent = `(${pageCount} page${pageCount > 1 ? 's' : ''})`;

      // Calculate scale based on cell height
      const page_inner_h_mm = 297 - 10; // A4 height minus 5mm padding on top and bottom
      const gap_mm = 2;
      const gaps_h_mm = (rows - 1) * gap_mm;
      const row_h_mm = (page_inner_h_mm - gaps_h_mm) / rows;
      const card_padding_v_mm = 4; // 2mm padding top + bottom

      // Base measurements for 10 rows
      const base_rows = 10;
      const base_gaps_h_mm = (base_rows - 1) * gap_mm;
      const base_row_h_mm = (page_inner_h_mm - base_gaps_h_mm) / base_rows;
      const base_card_padding_v_mm = 4;
      const base_inner_h_mm = base_row_h_mm - base_card_padding_v_mm;

      // Calculate scale to maximize content size
      const inner_h_mm = row_h_mm - card_padding_v_mm;
      let scale = inner_h_mm / base_inner_h_mm;
      // Cap scale to prevent overflow and ensure readability
      scale = Math.min(1.2, Math.max(0.8, scale));
      document.documentElement.style.setProperty('--scale', scale);

      previewContainer.innerHTML = '';
      for (let i = 0; i < allCards.length; i += cardsPerPage) {
        createPage(allCards.slice(i, i + cardsPerPage), rows, cols, i);
      }
    }

    function createPage(cards, rows, cols, startIndex) {
      const page = document.createElement('div');
      page.className = 'page';
      const grid = document.createElement('div');
      grid.className = 'card-grid';
      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
      cards.forEach((c, idx) => grid.appendChild(createCardElement(c, startIndex + idx + 1)));
      page.appendChild(grid); previewContainer.appendChild(page);
    }

    function createCardElement(card, cellNumber) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="topit">
          <div>
            <div class="card-amount">${card.network} ${card.amount}</div>
            <div class="card-ref">Ref: <span class="jbonly">J&B Concepts_${cellNumber}</span></div>
            <div class="card-serial">S/N: ${card.serial}</div>
          </div>
          <img class="card-logo" src="${networkLogos[card.network] || 'default.png'}" alt="${card.network}">
        </div>
        <div class="card-pin">PIN: <span class="pinonly">${card.pin}</span></div>
        <div class="card-date">${card.date}</div>`;
      return div;
    }

    downloadBtn.addEventListener('click', () => {
      if (!allCards.length) return alert('No cards to download.');
      const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      const pages = document.querySelectorAll('.page');
      const capturePage = idx => {
        if (idx >= pages.length) return doc.save('cards.pdf');
        html2canvas(pages[idx], { scale: 2, useCORS: true }).then(canvas => {
          if (idx > 0) doc.addPage('a4', 'portrait');
          doc.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, 210, 297);
          capturePage(idx + 1);
        });
      };
      capturePage(0);
    });

    printBtn.addEventListener('click', () => {
      if (!allCards.length) return alert('No cards to print.');
      window.print();
    });
  </script>
</body>
</html>